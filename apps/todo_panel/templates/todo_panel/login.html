{% extends 'todo_panel/base.html' %}

{% block title %}Iniciar Sesión - Panel de Tareas{% endblock %}

{% block content %}
<div class="login-container">
    <div class="card">
        <h1 class="login-title">Iniciar Sesión</h1>

        <div id="login-form">
            <div class="form-group">
                <label for="client_id" class="form-label">Client ID</label>
                <input type="text" id="client_id" name="client_id" required class="form-input"
                    placeholder="Ingresa tu Client ID de Azure">
            </div>

            <button onclick="startAuth()" id="login-btn" class="btn-primary">
                Conectar con Microsoft
            </button>
            <p id="error-msg" class="error-message"></p>
        </div>

        <div id="auth-step-2" style="display: none;" class="text-center">
            <div class="form-group">
                <p>Tu código de verificación es:</p>
                <h2 id="user-code" class="user-code"></h2>
                <p class="text-muted">Copia este código</p>
            </div>

            <p>Se ha abierto una ventana emergente para iniciar sesión.</p>
            <p>Si no se abrió, <a id="verification-link" href="#" target="_blank" class="link-primary">haz clic
                    aquí</a>.</p>

            <div style="margin-top: 2rem;">
                <div class="spinner"></div>
                <p class="text-muted" style="margin-top: 0.5rem;">Esperando autenticación...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}{% endblock %}

{% block extra_js %}
<script>
    // v3.0 - Con lock para prevenir requests concurrentes
    let pollInterval = null;
    let isPolling = false;
    let isRequestInFlight = false;
    let pollCount = 0;

    async function startAuth() {
        const clientId = document.getElementById('client_id').value;
        const btn = document.getElementById('login-btn');
        const errorMsg = document.getElementById('error-msg');

        if (!clientId) {
            errorMsg.textContent = "Por favor ingresa un Client ID";
            errorMsg.style.display = 'block';
            return;
        }

        btn.disabled = true;
        btn.textContent = "Iniciando...";
        errorMsg.style.display = 'none';

        try {
            const response = await fetch('{% url "todo_panel:initiate_auth" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ client_id: clientId })
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            document.getElementById('login-form').style.display = 'none';
            document.getElementById('auth-step-2').style.display = 'block';
            document.getElementById('user-code').textContent = data.user_code;
            document.getElementById('verification-link').href = data.verification_uri;

            window.open(data.verification_uri, 'microsoft_auth', 'width=600,height=700');
            startPolling(clientId, data.device_code);

        } catch (e) {
            errorMsg.textContent = e.message;
            errorMsg.style.display = 'block';
            btn.disabled = false;
            btn.textContent = "Conectar con Microsoft";
        }
    }

    function stopPolling() {
        console.log('[Polling] Deteniendo...');
        isPolling = false;
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
    }

    function startPolling(clientId, deviceCode) {
        console.log('[Polling] Iniciando...');
        stopPolling();

        isPolling = true;
        isRequestInFlight = false;
        pollCount = 0;

        const doPoll = async () => {
            if (!isPolling) {
                stopPolling();
                return;
            }

            // LOCK: Prevenir requests concurrentes
            if (isRequestInFlight) {
                console.log('[Polling] Request en vuelo, saltando...');
                return;
            }

            pollCount++;
            console.log(`[Polling] Intento #${pollCount}`);
            isRequestInFlight = true;

            try {
                const response = await fetch('{% url "todo_panel:check_auth_status" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        client_id: clientId,
                        device_code: deviceCode
                    })
                });

                const data = await response.json();
                console.log(`[Polling] Respuesta:`, data);

                if (data.status === 'success') {
                    console.log('[Polling] ¡Éxito!');
                    stopPolling();
                    window.location.href = '{% url "todo_panel:index" %}';

                } else if (data.error && data.status !== 'pending') {
                    console.error('[Polling] Error:', data.error);
                    stopPolling();

                    // NO mostrar alerta si es invalid_grant (device_code ya usado)
                    if (data.error_code !== 'invalid_grant') {
                        alert("Error de autenticación: " + data.error);
                    } else {
                        console.log('[Polling] Device code ya usado, redirigiendo...');
                    }

                    window.location.href = '{% url "todo_panel:index" %}';

                } else {
                    console.log('[Polling] Pendiente...');
                }

            } catch (e) {
                console.error('[Polling] Error de red:', e);
                stopPolling();
                alert("Error de conexión: " + e.message);
                location.reload();
            } finally {
                isRequestInFlight = false;
            }
        };

        pollInterval = setInterval(doPoll, 5000);
    }

    window.addEventListener('beforeunload', stopPolling);
    window.addEventListener('pagehide', stopPolling);
</script>
{% endblock %}